name: Apply Swarm Patch & Open PR

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  apply_patch:
    if: startsWith(github.event.comment.body, '/approve')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Extract latest swarm patch from comments
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { owner, repo } = context.repo;
            const issue_number = context.payload.issue?.number || context.payload.pull_request?.number;
            if (!issue_number) {
              core.setOutput('hasPatch', 'false');
              return;
            }

            // Fetch recent comments on the issue/PR
            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number,
              per_page: 100
            });

            // Find the most recent comment containing a SWARM_PATCH block
            const reversed = [...comments].reverse();
            const swarmComment = reversed.find(c => c.body && c.body.includes('SWARM_PATCH_START'));

            if (!swarmComment) {
              core.info('No swarm patch found on this issue.');
              core.setOutput('hasPatch', 'false');
              return;
            }

            const body = swarmComment.body;
            const match = body.match(/<!-- SWARM_PATCH_START -->([\s\S]*?)<!-- SWARM_PATCH_END -->/);
            if (!match) {
              core.info('SWARM patch markers present but no extractable patch block.');
              core.setOutput('hasPatch', 'false');
              return;
            }

            const patch = match[1].trim();
            if (!patch) {
              core.info('SWARM patch block was empty.');
              core.setOutput('hasPatch', 'false');
              return;
            }

            fs.writeFileSync('swarm.patch', patch);
            core.info('Wrote swarm.patch for application.');
            core.setOutput('hasPatch', 'true');

      - name: Apply patch and push branch
        if: steps.extract.outputs.hasPatch == 'true'
        run: |
          set -e
          git config user.name "swarm-bot"
          git config user.email "swarm-bot@users.noreply.github.com"

          ISSUE_NUMBER="${{ github.event.issue.number }}"
          TS="$(date +%s)"
          BRANCH="swarm/issue-${ISSUE_NUMBER}-${TS}"
          echo "BRANCH_NAME=$BRANCH" >> "$GITHUB_ENV"

          git checkout -b "$BRANCH"
          git apply swarm.patch

          git status
          git add -A
          git commit -m "chore(swarm): apply proposed fix for #${ISSUE_NUMBER}"
          git push origin "$BRANCH"

      - name: Open draft PR for review
        if: steps.extract.outputs.hasPatch == 'true'
        uses: actions/github-script@v7
        env:
          BRANCH_NAME: ${{ env.BRANCH_NAME }}
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.payload.issue.number;
            const head = process.env.BRANCH_NAME;
            const base = 'main';
            const title = `swarm: proposed fix for #${issue_number}`;
            const body = [
              `Automated patch from the swarm for issue #${issue_number}.`,
              '',
              'This PR was created after a human approval comment (`/approve`).',
              'Please review, adjust as needed, and merge when ready.'
            ].join('\n');

            const pr = await github.rest.pulls.create({
              owner,
              repo,
              title,
              head,
              base,
              body,
              draft: true
            });

            core.info(`Created draft PR #${pr.data.number} for branch ${head}.`)

