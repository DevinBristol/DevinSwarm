name: CI Failure â†’ Issue

on:
  workflow_run:
    workflows: ['PR Validate (Salesforce)']
    types: [completed]

permissions:
  contents: read
  issues: write

jobs:
  open_issue_on_failure:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    steps:
      - name: Open or update a CI failure Issue
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;
            const title = `CI failure: ${run.name} #${run.run_number}`;
            const body = `The workflow **${run.name}** failed.\nRun URL: ${run.html_url}\nEvent: ${run.event}`;
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner, repo: context.repo.repo, state: 'open', labels: 'ci-failure'
            });
            let existing = issues.find(i => i.title.includes(`${run.run_number}`));
            if (existing) {
              await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: existing.number, body });
            } else {
              await github.rest.issues.create({ owner: context.repo.owner, repo: context.repo.repo, title, body, labels: ['ci-failure','needs-attention'] });
            }
