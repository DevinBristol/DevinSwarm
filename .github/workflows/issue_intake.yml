name: Intake â†’ Agent Service

on:
  issues:
    types: [opened, labeled, edited]
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  notify_service:
    if: github.event_name == 'workflow_dispatch' || contains(github.event.issue.labels.*.name, 'intake') || contains(github.event.issue.labels.*.name, 'ci-failure')
    runs-on: ubuntu-latest
    steps:
      - name: POST /tasks to Agent Service
        env:
          URL: ${{ secrets.AGENT_SERVICE_URL }}
          TOKEN: ${{ secrets.AGENT_SERVICE_TOKEN }}
        run: |
          if [ -z "$URL" ] || [ -z "$TOKEN" ]; then
            echo "Agent Service not configured; skipping."
            exit 0
          fi
          node - <<'EOF'
          const fs = require('fs');
          const eventPath = process.env.GITHUB_EVENT_PATH;
          const payload = JSON.parse(fs.readFileSync(eventPath, 'utf8'));
          const issueNumber = payload.issue && payload.issue.number ? payload.issue.number : 0;
          const body = {
            type: "intake",
            repo: process.env.GITHUB_REPOSITORY,
            issueNumber,
            payload
          };
          fs.writeFileSync('payload.json', JSON.stringify(body));
          EOF
          curl -sS -X POST "$URL/tasks"             -H "Content-Type: application/json"             -H "x-agent-token: $TOKEN"             --data @payload.json
