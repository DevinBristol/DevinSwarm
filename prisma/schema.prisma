generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Run {
  id               String    @id @default(uuid())
  repo             String
  source           String    @default("manual")
  title            String?
  description      String?
  planSummary      String?
  state            RunState  @default(queued)
  phase            String    @default("intake")
  branch           String?
  currentNode      String    @default("intake")
  prNumber         Int?
  reviewStatus     String    @default("pending")
  opsStatus        String    @default("pending")
  retries          Json?
  tasks            Json?
  plan             Json?
  artifacts        Json?
  evaluation       Json?
  devAssignee      String?
  reviewerAssignee String?
  opsAssignee      String?
  priority         Int       @default(0)
  budgetUsd        Float     @default(5)
  startedAt        DateTime?
  completedAt      DateTime?
  lastError        String?
  statusHistory    Json?
  restartedFrom    String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  blockedReason    String?
  labels           String[]  @default([])
  events           Event[]
}

model Event {
  id        String   @id @default(uuid())
  runId     String
  run       Run      @relation(fields: [runId], references: [id], onDelete: Cascade)
  type      String
  node      String?
  status    String?
  reason    String?
  metadata  Json?
  payload   Json
  createdAt DateTime @default(now())

  @@index([runId])
}

enum RunState {
  queued
  running
  blocked
  awaiting_unblock
  done
  failed
}
